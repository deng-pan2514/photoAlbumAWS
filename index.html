<!DOCTYPE html>
<html lang="en">

<head>
  <title>Photo Album</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
    crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="lib/axios/dist/axios.standalone.js"></script>
  <script type="text/javascript" src="lib/CryptoJS/rollups/hmac-sha256.js"></script>
  <script type="text/javascript" src="lib/CryptoJS/rollups/sha256.js"></script>
  <script type="text/javascript" src="lib/CryptoJS/components/hmac.js"></script>
  <script type="text/javascript" src="lib/CryptoJS/components/enc-base64.js"></script>
  <script type="text/javascript" src="lib/url-template/url-template.js"></script>
  <script type="text/javascript" src="lib/apiGatewayCore/sigV4Client.js"></script>
  <script type="text/javascript" src="lib/apiGatewayCore/apiGatewayClient.js"></script>
  <script type="text/javascript" src="lib/apiGatewayCore/simpleHttpClient.js"></script>
  <script type="text/javascript" src="lib/apiGatewayCore/utils.js"></script>
  <script type="text/javascript" src="apigClient.js"></script>

  <script>
    window.SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
    const synth = window.speechSynthesis;
    const recognition = new SpeechRecognition();
  </script>

  <style>
    #top {
      font-size: 24px;
      font-weight: bold;
      color: red;
      margin-left: 10pt;
    }

    #search-top {
      margin-top: 35px;
      margin-left: 30px;
      font-size: 20px;
    }

    #inputbox {
      float: left;
      width: 30%;
      height: 30px;
    }

    #search {
      float: left;
      margin-left: 10px;
    }

    .container {
      margin-top: 15px;
    }

    .p1 {
      margin-top: 5px;
    }

    #uploadMessage {
      margin-top: 10px;
      color: green;
    }
  </style>
</head>

<body>

  <div id="top">
    Photo Album Assignment
  </div>

  <div id="search-top">
    <div id="container1">
      <input type="text" id="inputbox" placeholder="Search..." />
      <button id="search" class="btn btn-primary" type="button">Search</button>
      <span> &nbsp&nbsp&nbsp </span>
      <button id="mic-btn" class="btn btn-primary">
        <img src="mic.png" width="20">
      </button>
      <br>
    </div>
  </div>

  <div class="container">
    <form method="post" action="" enctype="multipart/form-data" id="myform">
      <input type="text" id="labelbox" placeholder="Custom Labels..." /> <br>
      <input type="file" id="image_input" accept="image/jpg, image/png">
      <input type="button" class="button" value="Upload" id="upload"> <br>
      <p id="uploadMessage"></p>
    </form>
  </div>

  <div>
    <table width="100%" style="height: 100%;">
      <tr>
        <td>
          <p id="photos"></p>
        </td>
        <td>
          <p id="contacts"></p>
        </td>
      </tr>
    </table>
  </div>

  <div id="div"></div>
  <div id="div1"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const micBtn = document.getElementById('mic-btn');

      micBtn.addEventListener('click', () => {
        recognition.start();
        recognition.onresult = (e) => {
          const transcript = e.results[0][0].transcript;
          const searchInput = document.getElementById('inputbox');
          searchInput.value = transcript;
        }
      });

      document.getElementById("upload").addEventListener("click", function () {
        console.log("Uploading!");
        const image_input = document.getElementById("image_input");
        const files = image_input.files[0];

        console.log('File:', files);
        console.log('File Type:', files.type);
        console.log('File Name:', files.name);

        encodeAndUpload(files);
      });

      document.getElementById("search").addEventListener("click", function () {
        console.log("Searching!");
        const query = document.getElementById("inputbox");
        params = { q: query.value };
        console.log(query.value);

        search();
      });

      function encodeAndUpload(file) {
        const labels = document.getElementById("labelbox").value;

        console.log('File:', file);
        console.log('File Type:', file.type);
        console.log('File Name:', file.name);

        const reader = new FileReader();

        reader.onloadend = function () {
          const base64data = reader.result.split(',')[1]; // Extracting base64 data

          var myHeaders = new Headers();
          myHeaders.append("x-api-key", "GcsD7LYjia6LwB4lmR7nt8T0y9hRlB16fccO2Q2g");
          myHeaders.append("x-amz-meta-customLabels", labels);
          myHeaders.append("Content-Type", file.type);

          var requestOptions = {
            method: 'PUT',
            headers: myHeaders,
            body: base64data, // Use base64 data instead of file
            redirect: 'follow'
          };

          fetch("https://sis0lue9b2.execute-api.us-east-1.amazonaws.com/test/upload/photoalb1/" + file.name, requestOptions)
            .then(response => {
              if (response.ok) {
                console.log("Upload successful!");
                document.getElementById("uploadMessage").innerText = "Upload successful!";
                // You can add additional logic or UI updates here if needed.
              } else {
                console.log("Upload failed. Please try again.");
                document.getElementById("uploadMessage").innerText = "Upload failed. Please try again.";
                // You can handle the failure case here.
              }
            })
            .catch(error => console.log('Error:', error));
        };

        reader.readAsDataURL(file); // Read file as base64
      }

      function search() {
        var searchTerm = document.getElementById("inputbox").value;
        var apigClient = apigClientFactory.newClient({
          apiKey: 'GcsD7LYjia6LwB4lmR7nt8T0y9hRlB16fccO2Q2g'
        });
        var params = {
          q: searchTerm
        };
        var body = {};
        var additionalParams = {};

        console.log(searchTerm);
        apigClient.searchGet(params, body, additionalParams)
          .then(function (result) {
            console.log('Success OK');
            console.log(result.data.body.results);
            var photos = result.data.body.results;
            var container = document.getElementById("photos");

            // Create an array of promises for fetching images
            var promises = photos.map(function (photo) {
              return fetch(photo.url)
                .then(response => response.blob())
                .then(blob => {
                  const reader = new FileReader();
                  return new Promise(function (resolve) {
                    reader.onloadend = function () {
                      const img = new Image();
                      img.alt = 'Photo';
                      img.style.width = '300px';
                      img.src = 'data:image/jpeg;base64,' + atob(reader.result.split(',')[1]);
                      container.appendChild(img);
                      resolve();
                    };
                    reader.readAsDataURL(blob);
                  });
                });
            });

            // Wait for all promises to resolve before further actions
            Promise.all(promises)
              .then(function () {
                console.log("All images loaded successfully!");
              })
              .catch(function (error) {
                console.log("Error loading images:", error);
              });

          })
          .catch(function (result) {
            console.log("Error:", result);
          });
      }
    });
  </script>
</body>

</html>
